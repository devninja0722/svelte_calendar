<div>
  <div id="header">
    <div class="left">
      <div class="nav-buttons">
        <button on:click="set({month: month === 0 ? 11 : month-1, year: month === 0 ? year-1 : year})">{{ previousText }}</button>
        <button on:click="set({month: (month+1)%12, year: month === 11 ? year + 1: year})">{{ nextText }}</button>
      </div>
      <span class="title">{{ year }} {{ monthName }}
        {{#if loading}}
          <small class="loading">{{ loadingText }}</small>
        {{/if}}
      </span>
    </div>
    <div class="right">
      <div class="view-buttons">
        <button class="{{ view === 'calendar' ? 'is-active': ''}}" on:click="set({view: 'calendar'})">{{ calendarText }}</button>
        <button style="margin-left: 5px" class="{{ view === 'list' ? 'is-active': ''}}" on:click="set({view: 'list'})">{{ listText }}</button>
      </div>
    </div>
  </div>
  {{#if view==='calendar' }}
    <table>
      <thead>
        <tr>
          {{#each dayNames as dayName}}
            <th>{{ dayName }}</th>
          {{/each}}
        </tr>
      </thead>
      <tbody>
        {{#each monthData.weeks as weekdays}}
          <tr>
            {{#each weekdays as weekday}}
              <td class="{{ weekday.number === '' ? 'filler' : ''}}">
                <span class="day-number">{{ weekday.number }}</span>
                {{#each weekday.entries as entry}}
                  <span class="entry {{ entry.content ? 'has-content' : ''}}" style="background-color: {{ entry.color || defaultColor }}; color: {{ colorContrast(entry.color) }}" on:click="loadEntry(entry)" title="{{ entry.title }}">{{ charLimit(entry.title, 30, untitledText) }}</span>
                {{/each}}
                {{#if showNew}}
                  <div class="add-new" on:click="fire('newClicked', {day: weekday})">+</div>
                {{/if}}
              </td>
            {{/each}}
          </tr>
        {{/each}}
      </tbody>
    </table>
  {{else}}
    {{#if monthData.numEntries===0 }}
      <div class="no-entries">{{emptyText}}</div>
    {{/if}}
    {{#each monthData.weeks as weekdays}}
      {{#each weekdays as weekday}}
        {{#if weekday.entries.length> 0}}
          <div class="row-header">
            {{ weekday.date.toDateString() }}
          </div>
          <div class="row-content">
            {{#each weekday.entries as entry}}
              <p>
                <span class="dot" style="background-color: {{ entry.color || defaultColor }}"></span>
                {{#if entry.timeFrom && entry.days.length===1 }}
                  <span class="row-entry-time">{{ entry.timeFrom }}</span>
                {{/if}}
                {{#if entry.timeTo && entry.days.length===1 }}
                  <span class="row-entry-time">- {{ entry.timeTo }}</span>
                {{/if}}
                <span class="row-entry-title" on:click="loadEntry(entry)">{{ charLimit(entry.title, 70, untitledText) }}</span>
              </p>
            {{/each}}
          </div>
        {{/if}}
      {{/each}}
    {{/each}}
  {{/if}}
</div>
<div class="modal {{ showModal ? 'is-active' : ''}}">
  <div class="modal-background" on:click="set({showModal: false})"></div>
  <div class="modal-content">
    <button class="modal-close" aria-label="close" on:click="set({showModal: false})">+</button>
    <div class="modal-container" ref:modalContent>
      {{#if activeEntry}}
        <span class="title modal-title">{{ activeEntry.title || untitledText }}</span>
        <div class="entry-meta">
          <strong>Start:</strong> {{activeEntry.startDate.toDateString()}}
          {{#if activeEntry.timeFrom}}
            <span class="time">{{ activeEntry.timeFrom }}</span>
          {{/if}}
          {{#if activeEntry.dateTo }}
            <br>
            <strong>End:</strong> {{activeEntry.endDate.toDateString()}}
            {{#if activeEntry.timeTo}}
              <span class="time">{{ activeEntry.timeTo }}</span>
            {{/if}}
          {{/if}}
        </div>
        {{#if activeEntry.image}}
          <img src="{{activeEntry.image}}" alt="{{activeEntry.title}}">
        {{/if}}
        {{#if escape }}{{ activeEntry.content }}{{else}}
          <div>{{{ activeEntry.content }}}</div>
        {{/if}}
      {{/if}}
    </div>
    {{#if modalButtons.length> 1}}
      <div class="modal-buttons">
        {{#each modalButtons as button}}
          <button class="button" on:click="fire(button.id, {entry: activeEntry})">{{button.text}}</button>
        {{/each}}
      </div>
    {{/if}}
  </div>

</div>

<style>
  * {
    font-family: Arial, Helvetica, sans-serif;
    box-sizing: border-box;
    -webkit-box-sizing: border-box;
    font-size: 14px;
  }

  img {
    max-width: 100%;
    margin-bottom: 1rem;
  }

  #header {
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-flow: row wrap;
  }

  small {
    font-size: 0.8rem;
    font-weight: 300;
  }

  .left,
  .right {
    display: flex;
  }

  @media screen and (max-width: 700px) {
    .nav-buttons {
      order: 3;
    }

    .view-buttons {
      order: 4;
    }

    .left,
    .right {
      flex-direction: column;
      align-self: flex-end;
    }

    .nav-buttons,
    .view-buttons {
      flex-basis: 49%;
      margin-top: 0.6rem;
    }

    .title {
      min-width: 60%;
    }
  }

  .nav-buttons {
    margin-right: 1rem;
  }

  .title {
    font-weight: 600;
    font-size: 1.5rem;
  }

  .modal-title {
    display: block;
    margin-bottom: 2rem;
  }

  .loading {
    padding: 0 0.6rem;
  }

  table {
    width: 100%;
    max-width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  tbody tr {
    height: 150px;
  }

  th {
    background: whitesmoke;
  }

  td {
    text-align: right;
    vertical-align: top;
  }

  th,
  td {
    border: 1px solid #ddd;
  }

  button {
    border: 1px solid #333;
    border-radius: 3px;
    padding: 0.3rem 0.6rem;
    background: white;
    color: black;
  }

  button:hover {
    cursor: pointer;
    background: #ddd;
  }

  button.is-active {
    background-color: #666;
    color: white;
  }

  .entry {
    display: block;
    background-color: darkblue;
    padding: 0.1rem 0.3rem;
    width: 100%;
    color: white;
    border-radius: 3px;
    text-align: left;
    margin-bottom: 3px;
    cursor: pointer;
  }

  @media screen and (max-width: 600px) {
    .entry {
      font-size: 0;
      height: 20px;
    }
  }

  .filler {
    border: none;
  }

  .time {
    text-decoration: underline;
  }

  .add-new {
    background-color: whitesmoke;
    width: 100%;
    padding: 0.5rem 0;
    text-align: center;
    border: 2px dashed #ccc;
    cursor: pointer;
    display: none;
    font-weight: 600;
    font-size: 1.5rem;
    color: #777;
  }

  td:not(.filler):hover .add-new {
    display: block;
  }

  .row-header {
    background-color: whitesmoke;
    padding: 0.8rem 1rem;
    font-weight: 600;
  }

  .row-content {
    padding: 0.8rem 1rem;
  }

  .dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 6px;
  }

  .row-entry-title:hover {
    text-decoration: underline;
    cursor: pointer;
  }

  .row-entry-time {
    font-weight: 600;
  }

  .no-entries {
    text-align: center;
    padding: 10rem 0;
    width: 100%;
    background-color: whitesmoke;
  }

  .modal {
    bottom: 0;
    left: 0;
    right: 0;
    top: 0;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    display: none;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    overflow: hidden;
    position: fixed;
    z-index: 20;
  }

  .modal.is-active {
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
  }

  .modal-background {
    bottom: 0;
    left: 0;
    position: fixed;
    right: 0;
    top: 0;
    background-color: rgba(10, 10, 10, 0.86);
  }

  .modal-content {
    margin: 0 20px;
    max-height: calc(100vh - 100px);
    overflow: auto;
    position: relative;
    width: 100%;
    padding: 2rem;
    background-color: white;
    border-radius: 3px;
  }

  @media screen and (min-width: 769px),
  print {
    .modal-content {
      margin: 0 auto;
      max-height: calc(100vh - 40px);
      width: 640px;
    }
  }

  .modal-close {
    outline: none;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -moz-appearance: none;
    -webkit-appearance: none;
    border-radius: 290486px;
    position: absolute;
    vertical-align: top;
    background: none;
    width: 30px;
    height: 30px;
    right: 0;
    top: 20px;
    -webkit-transform: translateX(-50%) translateY(-50%) rotate(45deg);
    transform: translateX(-50%) translateY(-50%) rotate(45deg);
    -webkit-transform-origin: center center;
    transform-origin: center center;
    border: none;
    font-size: 20px;
    font-weight: 600;
  }

  .entry-meta {
    margin-bottom: 1rem;
  }

  .modal-buttons {
    margin-top: 1rem;
  }

  .modal-buttons button {
    margin-right: 5px;
  }

</style>

<script>
  export default {
    data: function () {
      return {
        monthNames: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
        dayNames: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
        month: (new Date()).getMonth(),
        day: (new Date()).getDate(),
        year: (new Date()).getFullYear(),
        escape: true,
        previousText: "Prev",
        nextText: "Next",
        calendarText: "Calendar",
        listText: "List",
        untitledText: "Untitled",
        emptyText: "No Events To Display",
        view: 'calendar',
        defaultColor: '#00008b',
        showModal: false,
        activeEntry: null,
        showNew: false,
        entries: [],
        parsedEntries: [],
        loading: false,
        loadingText: 'loading...',
        modalButtons: []
      }
    },
    methods: {
      loadEntry: function (entry) {
        this.fire('entryClicked', { entry: entry })
        this.set({
          showModal: true,
          activeEntry: entry,
        })
      },
    },
    helpers: {
      charLimit: function (str, n, empty) {
        if (!str) return empty || ' '
        if (str.length <= n) return str
        return str.substr(0, n) + '...'
      },
      colorContrast: function (hex) {
        if (!hex) return '#ffffff'
        var color = (hex.charAt(0) === '#') ? hex.substring(1, 7) : hex;
        var r = parseInt(color.substring(0, 2), 16); // hexToR
        var g = parseInt(color.substring(2, 4), 16); // hexToG
        var b = parseInt(color.substring(4, 6), 16); // hexToB
        return (((r * 0.299) + (g * 0.587) + (b * 0.114)) > 186) ? '#000000' : '#ffffff';
      }
    },
    oncreate: function () {
      var calendar = this
      window.addEventListener('keydown', function (e) {
        if (e.keyCode === 27) { calendar.set({ showModal: false }) }
      })
      this.observe('showModal', function (showModal) {
        if (!showModal) {
          this.set({ activeEntry: null })
          this.refs.modalContent.innerHTML = ''
          document.querySelector('html').style.overflow = ''
        } else {
          document.querySelector('html').style.overflow = 'hidden'
        }
      })
      this.observe('entries', function (entries) {

        var parsedEntries = entries.map(function (e) {
          if (!e.id) e.id = Math.random().toString(36).substr(2)
          if (!e.color) e.color = calendar.get('defaultColor')
          e.startDate = new Date(Date.parse(e.dateFrom))
          e.days = [e.startDate.toDateString()]
          if (e.dateTo) {
            e.endDate = new Date(Date.parse(e.dateTo))
            var deltaStart = new Date(+e.startDate)
            var deltaEnd = new Date(+e.endDate);
            ;[deltaStart, deltaEnd].forEach(function (d) {
              d.setHours(0)
              d.setMinutes(0)
              d.setSeconds(0)
              d.setMilliseconds(0)
            })
            var deltaDays = Math.round((deltaEnd - deltaStart) / 1000 / 60 / 60 / 24);
            for (var i = 0; i < deltaDays; i++) {
              var date = new Date(+e.startDate)
              date.setDate(date.getDate() + i + 1)
              e.days.push(date.toDateString())
            }
          }
          return e
        })
        this.set({ parsedEntries: parsedEntries })
      })
    },
    computed: {
      monthName: function (month, monthNames) {
        return monthNames[month]
      },
      monthData: function (year, month, parsedEntries) {
        var weeks = []
        var start = (new Date(year, month, 1)).getDay()
        var days = []
        var feb = (year % 100 != 0) && (year % 4 == 0) || (year % 400 == 0) ? 29 : 28
        var dayPerMonth = [31, feb, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]
        var numDays = dayPerMonth[month]
        var numEntries = 0
        for (var i = 0; i < start; i++) {
          days.push({ number: '', entries: [] })
        }
        for (var i = 0; i < numDays; i++) {
          var date = new Date(year, month, i + 1)
          var entries = parsedEntries.filter(function (e) {
            return e.days.indexOf(date.toDateString()) > -1
          })
          numEntries += entries.length
          days.push({
            number: i + 1,
            date: date,
            entries: entries,
          })
        }
        for (var i = 0; i < days.length; i += 7) {
          weeks.push(days.slice(i, i + 7))
        }
        var finalWeek = weeks[weeks.length - 1]
        var toAdd = 7 - finalWeek.length
        for (var i = 0; i < toAdd; i++) {
          finalWeek.push({ number: '', entries: [] })
        }
        return {
          weeks: weeks,
          numEntries: numEntries,
        }
      }

    }
  }
</script>
