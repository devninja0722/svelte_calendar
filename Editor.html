<div class="modal {{ show ? 'is-active' : ''}}">
  <div class="modal-background" on:click="set({show: false})"></div>
  <div class="modal-content">
    <button class="modal-close" aria-label="close" on:click="set({show: false})">+</button>
    <div class="modal-container" ref:modalContent>
      <span class="title modal-title">{{ mode === 'create' ? newTitleText : editTitleText }}</span>
      <div class="field">
        <label>Entry Title</label>
        <input id="entry-title" placeholder="Enter a short but descriptive title" bind:value="entry.title">
      </div>
      <div class="field">
        <label>Date From</label>
        <input type="date" bind:value="entry.dateFrom">
        {{#if entry.dateFrom }}
          <p class="help">{{ niceDate(entry.dateFrom) }}</p>
        {{/if}}
      </div>
      <div class="field">
        <label>Time From</label>
        <input type="time" placeholder="optional" bind:value="entry.timeFrom">
      </div>
      <div class="field">
        <label>Date To</label>
        <input type="date" bind:value="entry.dateTo">
        {{#if entry.dateTo }}
          <p class="help">{{ niceDate(entry.dateTo) }}</p>
        {{/if}}
      </div>
      <div class="field">
        <label>Time To</label>
        <input type="time" placeholder="optional" bind:value="entry.timeTo">
      </div>
      <div class="field">
        <label>Entry Color</label>
        <input id="entry-color" type="color" bind:value="entry.color">
      </div>
      <div class="field">
        <label>Content</label>
        <textarea bind:value="entry.content"></textarea>
      </div>
      <button class="button" on:click="submit()" ref:submitButton>Submit</button>
    </div>
  </div>
</div>

<script>

  function getDays(year, month) {
    var days = []
    var feb = (year % 100 != 0) && (year % 4 == 0) || (year % 400 == 0) ? 29 : 28
    var dayPerMonth = [31, feb, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]
    var numDays = dayPerMonth[month]
    for (var i = 1; i <= numDays; i++) {
      days.push(i)
    }
    return days
  }



  export default {
    oncreate: function () {

      var calendar = this.get('calendar')
      var editor = this

      this.set({
        monthNames: calendar.get('monthNames'),
        defaultColor: calendar.get('defaultColor'),
      })

      this.clearEntry()

      calendar.on('newClicked', function (event) {
        var date = event.day.date
        date.setHours(10)
        editor.set({
          show: true,
          entry: {
            title: '',
            dateFrom: date.toISOString().substr(0, 10),
            dateTo: date.toISOString().substr(0, 10),
            color: this.get('defaultColor'),
            content: '',
          }
        })
      })

      calendar.on('editClicked', function (event) {
        var entry = event.entry
        calendar.set({ showModal: false })
        editor.set({
          show: true,
          mode: 'edit',
        })
      })

      calendar.on('deleteClicked', function (event) {
        var entry = event.entry
        if (confirm("Really delete? There is no undo.")) {
          editor.delete(entry)
          calendar.set({ showModal: false })
        }
      })

      calendar.on('entryClicked', function (event) {
        var entry = event.entry
        editor.set({ entry: entry })
        calendar.set({
          modalButtons: [
            { text: 'Edit', id: 'editClicked' },
            { text: 'Delete', id: 'deleteClicked' }
          ]
        })
      })
      this.observe('show', function (show) {
        if (!show) {
          document.querySelector('html').style.overflow = ''
        } else {
          document.querySelector('html').style.overflow = 'hidden'
        }
      })

    },
    data: function () {
      return {
        calendar: null,
        show: false,
        mode: 'create', // or 'edit'
        entry: {},
        monthNames: [],
        months: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
        newTitleText: 'Add New Entry',
        editTitleText: 'Edit Entry',
      }
    },
    helpers: {
      niceDate: function (dateString) {
        if (!dateString) return ''
        var date = (new Date(dateString))
        if (date.toString().indexOf('nvalid') > -1) return "Invalid Date"
        return date.toDateString()
      }
    },
    methods: {
      clearEntry: function () {
        this.set({
          entry: {
            dateFrom: (new Date()).toISOString().substr(0, 10),
            dateTo: (new Date()).toISOString().substr(0, 10),
            title: '',
            color: this.get('defaultColor'),
            content: ''
          }
        })
      },
      submit: function () {
        var mode = this.get('mode')
        if (mode === 'create') this.create()
        if (mode === 'edit') this.update()
      },
      update: function () {
        var calendar = this.get('calendar')
        var entry = this.get('entry')
        if (!entry.id) return false
        var entries = calendar.get('entries')
        var index = entries.findIndex(function (e) { return e.id === entry.id })
        if (index < 0) return false
        entries.splice(index, 1, entry)
        calendar.set({ entries: entries })
        this.clearEntry()
        this.set({ show: false })
      },
      create: function () {
        var calendar = this.get('calendar')
        var entry = this.get('entry')
        var entries = calendar.get('entries')
        entries.push(entry)
        calendar.set({ entries: entries })
        this.set({ show: false })
      },
      delete: function (entry) {
        var calendar = this.get('calendar')
        if (!entry.id) return false
        var entries = calendar.get('entries')
        var index = entries.findIndex(function (e) { return e.id === entry.id })
        if (index < 0) return false
        entries.splice(index, 1)
        calendar.set({ entries: entries })
        this.clearEntry()
        this.set({ show: false })
      }
    },
    computed: {
      fromYears: function (entry, yearFrom) {
        var start = parseInt(yearFrom)
        var years = []
        for (var i = -10; i < 20; i++) {
          years.push(start + i)
        }
        return years
      },
      toYears: function (entry, yearFrom) {
        if (!entry.startDate) return []
        var start = Math.max(parseInt(entry.startDate.getFullYear()), parseInt(yearFrom))
        var years = []
        for (var i = 0; i < 10; i++) {
          years.push(start + i)
        }
        return years
      },
      fromDays: function (entry, yearFrom, monthFrom) {
        return getDays(yearFrom, monthFrom)
      },
      toDays: function (entry, yearTo, monthTo) {
        return getDays(yearTo, monthTo)
      },
    }
  }
</script>

<style>
  * {
    font-family: Arial, Helvetica, sans-serif;
    box-sizing: border-box;
    -webkit-box-sizing: border-box;
    font-size: 14px;
  }

  input,
  textarea {
    border: 1px solid #ccc;
    margin-top: 0.1rem;
    margin-bottom: 0.1rem;
    margin-right: 0.1rem;
    padding: 0.4rem 0.6rem;
    font-family: monospace;
    font-size: 14px;
    color: black;
    background-color: white;
  }

  textarea {
    min-height: 100px;
  }

  .help {
    margin: 0.4rem 0;
    font-size: 0.9rem;
    color: #333;
    font-style: italic;
  }

  .button-bar {
    margin-top: 1rem;
    display: flex;
    justify-content: space-between;
  }

  input[type="color"] {
    padding: initial;
    background: white;
    border: none;
    width: 40px;
    height: 40px;
  }

  input[type="color"]:hover {
    cursor: pointer;
  }

  button {
    font-family: Arial, Helvetica, sans-serif;
    border: 1px solid #333;
    border-radius: 3px;
    padding: 0.3rem 0.6rem;
    background: white;
    color: black;
  }

  button:hover {
    cursor: pointer;
    background: #ddd;
  }

  .field {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
  }

  .field label {
    margin-bottom: 0.2rem;
    color: #333;
  }

  .modal {
    bottom: 0;
    left: 0;
    right: 0;
    top: 0;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    display: none;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    overflow: hidden;
    position: fixed;
    z-index: 20;
  }

  .modal.is-active {
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
  }

  .modal-background {
    bottom: 0;
    left: 0;
    position: fixed;
    right: 0;
    top: 0;
    background-color: rgba(10, 10, 10, 0.86);
  }

  .modal-content {
    margin: 0 20px;
    max-height: calc(100vh - 100px);
    overflow: auto;
    position: relative;
    width: 100%;
  }

  @media screen and (min-width: 769px),
  print {
    .modal-content {
      margin: 0 auto;
      max-height: calc(100vh - 40px);
      width: 640px;
    }
  }

  .modal-close {

    outline: none;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -moz-appearance: none;
    -webkit-appearance: none;
    border-radius: 290486px;
    position: absolute;
    vertical-align: top;
    background: none;
    width: 30px;
    height: 30px;
    right: 0;
    top: 20px;
    -webkit-transform: translateX(-50%) translateY(-50%) rotate(45deg);
    transform: translateX(-50%) translateY(-50%) rotate(45deg);
    -webkit-transform-origin: center center;
    transform-origin: center center;
    border: none;
    font-size: 20px;
    font-weight: 600;
  }

  .modal-container {
    padding: 2rem;
    background-color: white;
    border-radius: 3px;
  }

  .modal-title {
    display: block;
    margin-bottom: 2rem;
  }

  .title {
    font-weight: 600;
    font-size: 1.5rem;
  }

</style>
